Флаг переполнения таймера/счетчика (TOV1) устанавливается каждый раз, когда счетчик достигает TOP. Кроме того, флаг OCF1A или ICF1 устанавливается в тот же такт таймера, что и TOV1, когда для определения значения TOP используется либо OCR1A, либо ICR1. Если одно из прерываний разрешено, процедура обработки прерывания может использоваться для обновления значений TOP и сравнения.
При изменении значения TOP программа должна убедиться, что новое значение TOP больше или равно значению всех регистров сравнения. Если значение TOP ниже любого из регистров сравнения, совпадение сравнения никогда не произойдет между TCNT1 и OCR1x.
Обратите внимание, что при использовании фиксированных значений TOP неиспользуемые биты маскируются до нуля при записи любого из регистров OCR1x.
Процедура обновления ICR1 отличается от обновления OCR1A при использовании для определения значения TOP. Регистр ICR1 не подвергается двойной буферизации. Это означает, что если ICR1 изменяется на низкое значение, когда счетчик работает без предварительного делителя или с низким значением предварительного делителя, существует риск того, что новое записанное значение ICR1 будет ниже текущего значения TCNT1. Результатом будет то, что счетчик пропустит совпадение сравнения при значении TOP.
Счетчик затем должен будет досчитать до максимального значения (0xFFFF) и циклически начать с 0x0000, прежде чем может произойти сравнение совпадений. Однако регистр OCR1A имеет двойную буферизацию. Эта функция позволяет записывать местоположение ввода-вывода OCR1A в любое время. Когда ячейка ввода/вывода OCR1A записана, записанное значение будет помещено в буферный регистр OCR1A. Затем регистр сравнения OCR1A будет обновлен с помощью
значение в буферном регистре на следующем такте таймера TCNT1 соответствует TOP. Обновление выполняется в том же такте таймера, когда сбрасывается TCNT1 и устанавливается флаг TOV1.
Использование регистра ICR1 для определения TOP хорошо работает при использовании фиксированных значений TOP. При использовании ICR1 регистр OCR1A можно использовать для генерации ШИМ-выхода на OC1A. Однако, если базовая частота ШИМ активно изменяется (путем изменения значения TOP), использование OCR1A в качестве TOP, безусловно, является лучшим выбором из-за его функции двойного буфера.
В быстром режиме ШИМ блоки сравнения позволяют генерировать сигналы ШИМ на выводах OC1x.
Установка битов COM1x1:0 в 2 приведет к неинвертированному ШИМ и инвертированному выходу ШИМ.
можно сгенерировать, установив для COM1x1:0 значение 3. См. Таблица 16-3 на стр. 100. Фактическое значение OC1x
значение будет видно на выводе порта только в том случае, если направление данных для вывода порта установлено как выход (DDR_OC1x). Сигнал ШИМ генерируется установкой (или очисткой) регистра OC1x в
сравнение совпадений между OCR1x и TCNT1 и очистка (или установка) регистра OC1x в такт таймера, счетчик очищается (меняется с TOP на BOTTOM).